project(diffpng)

cmake_minimum_required(VERSION 2.4)

add_executable(
  diffpng diffpng.cpp lodepng.cpp)

install(TARGETS diffpng DESTINATION bin)

set(CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR})

set(CMAKE_BUILD_TYPE Debug)
#set(CMAKE_BUILD_TYPE Release)

set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall")

#
# Regression tests
#
# To test whether diffpng is operating properly, there are a large set of
# regression test images included under the 'test' directory.
# 
# Images follow a naming pattern. The images under 'the test/matches' directory
# have a pair file1.png file2.png, and diffpng should consider them to be
# perceptually the same.
#
# Images under the 'test/differs' directory also have pairs, file1.png file2.png
# and diffpng should consider them to be visually different from each other.
#
# The list of ctests to run is generated by reading all files in these
# two directories then generating a huge list of the file-pairs and the
# expected result, MATCHES or DIFFERS. (currently called PASS or FAIL).
#
# diffpng is then run on each pair, and if it correctly detects the images 
# as either matching or being different, the Ctest will report "Pass".
#
# Note that ctest looks at the return values from diffpng's "main()"
# to determine pass (0) or fail (1).
#
# Todo: fix terminology of diffpng to be MATCHES or DIFFERS

enable_testing()

file(GLOB differspngs "${PROJECT_SOURCE_DIR}/test/differs/*1.png")
file(GLOB matchespngs "${PROJECT_SOURCE_DIR}/test/matches/*1.png")
#message(STATUS "differs--> ${failpngs}")

function(setup_testline filename1 test_or_fail)
  string(REPLACE "${PROJECT_SOURCE_DIR}/test" "" pngfile ${pngfile})
  set(filename1 "${pngfile}")
  string(REPLACE "1.png" "2.png" filename2 ${filename1})
  set(testline "${test_or_fail} ${filename1} ${filename2}")
  # message(STATUS "testline--> ${testline}")
  set(testlines "${testlines};${testline}" PARENT_SCOPE)
endfunction(setup_testline)

foreach(pngfile ${differspngs})
  setup_testline(${pngfile} "FAIL")
endforeach()
foreach(pngfile ${matchespngs})
  setup_testline(${pngfile} "PASS")
endforeach()

# message(STATUS "xxxxxx ${testlines}")

# store our --output generated 'difference' images.
file(MAKE_DIRECTORY "${PROJECT_BINARY_DIR}/imagediffs")

set(counter ".")
foreach(testline ${testlines})

  # message(STATUS "Processing testline: ${testline}")
  string(REGEX REPLACE "(.*) .* .*" "\\1" expected_result ${testline})
  string(REGEX REPLACE ".* (.*) .*" "\\1" img1 ${testline})
  string(REGEX REPLACE ".* .* (.*)" "\\1" img2 ${testline})
  #message(STATUS "img1 ${img1}")
  #message(STATUS "img2 ${img2}")
  #message(STATUS "expected_result ${expected_result}")

  set(testname "${img1}_vs_${img2}")
  string(REGEX REPLACE "\\.png" "" testname ${testname})
  string(REGEX REPLACE "/" "-" testname ${testname})
  string(REGEX REPLACE "^-" "" testname ${testname})
  string(REGEX REPLACE "_-" "_" testname ${testname})
  string(REGEX REPLACE "[^A-Za-z0-9_-]+" "" testname ${testname})

  set(img1 "${PROJECT_SOURCE_DIR}/test/${img1}")
  set(img2 "${PROJECT_SOURCE_DIR}/test/${img2}")

  if(${expected_result} STREQUAL "FAIL")
    set(fliparg "--flipexit")
  else()
    set(fliparg "")
  endif()

  set(diffimg "${PROJECT_BINARY_DIR}/imagediffs/${testname}.png")
  add_test(NAME ${testname} COMMAND "${PROJECT_BINARY_DIR}/diffpng" "${img1}" "${img2}" ${fliparg} "--output" "${diffimg}")
  set(counter "${counter}.")

endforeach()
string(LENGTH ${counter} numtests)
message(STATUS "Tests added: " ${numtests})

add_custom_target(check COMMAND ${CMAKE_CTEST_COMMAND} DEPENDS "diffpng")
